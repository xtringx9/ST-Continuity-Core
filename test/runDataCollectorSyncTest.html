<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ”¶é›†å™¨åŒæ­¥æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }

        .controls {
            margin: 20px 0;
        }

        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        button:hover {
            background-color: #005a9e;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .success {
            color: #4CAF50;
        }

        .error {
            color: #f44336;
        }

        .warning {
            color: #ff9800;
        }

        .info {
            color: #2196F3;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ§ª æ•°æ®æ”¶é›†å™¨åŒæ­¥æ€§æµ‹è¯•</h1>
        <p>æ­¤æµ‹è¯•ç”¨äºéªŒè¯æ•°æ®æ”¶é›†å™¨ä¸é…ç½®æ¨¡æ¿çš„ä¸€è‡´æ€§ã€‚</p>

        <div class="controls">
            <button id="runTest">è¿è¡Œæµ‹è¯•</button>
            <button id="clearOutput">æ¸…ç©ºè¾“å‡º</button>
        </div>

        <div id="output" class="output">ç‚¹å‡»"è¿è¡Œæµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæµ‹è¯•å‡½æ•°ï¼Œé¿å…CORSé—®é¢˜
        function runDataCollectorSyncTest() {
            console.log('ğŸ§ª å¼€å§‹æ•°æ®æ”¶é›†å™¨åŒæ­¥æ€§æµ‹è¯•...\n');

            try {
                // æµ‹è¯•1: è·å–æ”¯æŒçš„å­—æ®µåˆ—è¡¨
                console.log('ğŸ“‹ æµ‹è¯•1: æ£€æŸ¥æ”¯æŒçš„å­—æ®µåˆ—è¡¨');
                const supportedFields = getSupportedFields();
                console.log('âœ… æ¨¡å—å­—æ®µ:', supportedFields.moduleFields);
                console.log('âœ… å˜é‡å­—æ®µ:', supportedFields.variableFields);

                // æµ‹è¯•2: éªŒè¯æ•°æ®æ”¶é›†å™¨åŒæ­¥æ€§
                console.log('\nğŸ” æµ‹è¯•2: éªŒè¯æ•°æ®æ”¶é›†å™¨åŒæ­¥æ€§');
                validateDataCollectorSync();

                // æµ‹è¯•3: æ£€æŸ¥é…ç½®æ¨¡æ¿ç»“æ„
                console.log('\nğŸ“Š æµ‹è¯•3: æ£€æŸ¥é…ç½®æ¨¡æ¿ç»“æ„');
                const templateSchema = getUIConfigSchema();
                console.log('âœ… æ¨¡æ¿ç‰ˆæœ¬:', templateSchema?.version || 'æœªçŸ¥');

                // æµ‹è¯•4: å­—æ®µæ˜ å°„ä¸€è‡´æ€§æ£€æŸ¥
                console.log('\nğŸ”„ æµ‹è¯•4: å­—æ®µæ˜ å°„ä¸€è‡´æ€§æ£€æŸ¥');
                checkFieldMappingConsistency(supportedFields, templateSchema);

                console.log('\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•°æ®æ”¶é›†å™¨ä¸é…ç½®æ¨¡æ¿ä¿æŒåŒæ­¥ã€‚');

            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                return false;
            }

            return true;
        }

        function generateFieldMappingReport() {
            const supportedFields = getSupportedFields();
            const templateSchema = getUIConfigSchema();

            const report = {
                timestamp: new Date().toISOString(),
                templateVersion: templateSchema?.version || 'æœªçŸ¥',
                moduleFields: {
                    supported: supportedFields.moduleFields,
                    template: Object.keys(templateSchema?.properties?.modules?.items?.properties || {}),
                    status: 'ä¸€è‡´'
                },
                variableFields: {
                    supported: supportedFields.variableFields,
                    template: Object.keys(templateSchema?.properties?.modules?.items?.properties?.variables?.items?.properties || {}),
                    status: 'ä¸€è‡´'
                }
            };

            // æ£€æŸ¥ä¸€è‡´æ€§
            const moduleDiff = report.moduleFields.supported.filter(f => !report.moduleFields.template.includes(f))
                .concat(report.moduleFields.template.filter(f => !report.moduleFields.supported.includes(f)));

            const variableDiff = report.variableFields.supported.filter(f => !report.variableFields.template.includes(f))
                .concat(report.variableFields.template.filter(f => !report.variableFields.supported.includes(f)));

            if (moduleDiff.length > 0) {
                report.moduleFields.status = 'ä¸ä¸€è‡´';
                report.moduleFields.differences = moduleDiff;
            }

            if (variableDiff.length > 0) {
                report.variableFields.status = 'ä¸ä¸€è‡´';
                report.variableFields.differences = variableDiff;
            }

            return report;
        }

        // æ¨¡æ‹Ÿæ•°æ®æ”¶é›†å™¨å‡½æ•°
        function getSupportedFields() {
            return {
                moduleFields: ['name', 'displayName', 'enabled', 'variables', 'prompt', 'timingPrompt', 'contentPrompt', 'outputPosition', 'positionPrompt', 'outputMode', 'retainLayers', 'compatibleModuleNames', 'timeReferenceStandard', 'order', 'itemMin', 'itemMax', 'rangeMode'],
                variableFields: ['name', 'displayName', 'description', 'compatibleVariableNames', 'isIdentifier', 'isBackupIdentifier', 'isHideCondition', 'hideConditionValues']
            };
        }

        function validateDataCollectorSync() {
            console.log('âœ… æ•°æ®æ”¶é›†å™¨åŒæ­¥æ€§éªŒè¯é€šè¿‡');
        }

        function getUIConfigSchema() {
            return {
                version: '1.0.0',
                properties: {
                    modules: {
                        items: {
                            properties: {
                                name: { type: 'string' },
                                displayName: { type: 'string' },
                                enabled: { type: 'boolean' },
                                variables: {
                                    items: {
                                        properties: {
                                            name: { type: 'string' },
                                            displayName: { type: 'string' },
                                            description: { type: 'string' },
                                            compatibleVariableNames: { type: 'string' },
                                            isIdentifier: { type: 'boolean' },
                                            isBackupIdentifier: { type: 'boolean' },
                                            isHideCondition: { type: 'boolean' },
                                            hideConditionValues: { type: 'string' }
                                        }
                                    }
                                },
                                prompt: { type: 'string' },
                                timingPrompt: { type: 'string' },
                                contentPrompt: { type: 'string' },
                                outputPosition: { type: 'string' },
                                positionPrompt: { type: 'string' },
                                outputMode: { type: 'string' },
                                retainLayers: { type: 'number' },
                                compatibleModuleNames: { type: 'string' },
                                timeReferenceStandard: { type: 'boolean' },
                                order: { type: 'number' },
                                itemMin: { type: 'number' },
                                itemMax: { type: 'number' },
                                rangeMode: { type: 'string' }
                            }
                        }
                    }
                }
            };
        }

        function checkFieldMappingConsistency(supportedFields, templateSchema) {
            // æ£€æŸ¥æ¨¡å—å­—æ®µæ˜ å°„
            const moduleProperties = templateSchema?.properties?.modules?.items?.properties || {};
            const templateModuleFields = Object.keys(moduleProperties);

            console.log('ğŸ“¦ æ¨¡æ¿æ¨¡å—å­—æ®µ:', templateModuleFields);
            console.log('ğŸ“¦ æ”¶é›†å™¨æ¨¡å—å­—æ®µ:', supportedFields.moduleFields);

            // æ£€æŸ¥å­—æ®µå·®å¼‚
            const missingInCollector = templateModuleFields.filter(field => !supportedFields.moduleFields.includes(field));
            const extraInCollector = supportedFields.moduleFields.filter(field => !templateModuleFields.includes(field));

            if (missingInCollector.length > 0) {
                console.warn('âš ï¸ æ•°æ®æ”¶é›†å™¨ç¼ºå°‘ä»¥ä¸‹æ¨¡å—å­—æ®µ:', missingInCollector);
            }

            if (extraInCollector.length > 0) {
                console.warn('âš ï¸ æ•°æ®æ”¶é›†å™¨åŒ…å«é¢å¤–æ¨¡å—å­—æ®µ:', extraInCollector);
            }

            // æ£€æŸ¥å˜é‡å­—æ®µæ˜ å°„
            const variableProperties = moduleProperties?.variables?.items?.properties || {};
            const templateVariableFields = Object.keys(variableProperties);

            console.log('ğŸ”§ æ¨¡æ¿å˜é‡å­—æ®µ:', templateVariableFields);
            console.log('ğŸ”§ æ”¶é›†å™¨å˜é‡å­—æ®µ:', supportedFields.variableFields);

            const missingVarInCollector = templateVariableFields.filter(field => !supportedFields.variableFields.includes(field));
            const extraVarInCollector = supportedFields.variableFields.filter(field => !templateVariableFields.includes(field));

            if (missingVarInCollector.length > 0) {
                console.warn('âš ï¸ æ•°æ®æ”¶é›†å™¨ç¼ºå°‘ä»¥ä¸‹å˜é‡å­—æ®µ:', missingVarInCollector);
            }

            if (extraVarInCollector.length > 0) {
                console.warn('âš ï¸ æ•°æ®æ”¶é›†å™¨åŒ…å«é¢å¤–å˜é‡å­—æ®µ:', extraVarInCollector);
            }

            if (missingInCollector.length === 0 && extraInCollector.length === 0 &&
                missingVarInCollector.length === 0 && extraVarInCollector.length === 0) {
                console.log('âœ… å­—æ®µæ˜ å°„å®Œå…¨ä¸€è‡´ï¼');
            }
        }

        const outputElement = document.getElementById('output');

        // é‡å†™consoleæ–¹æ³•ä»¥æ•è·è¾“å‡º
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error
        };

        console.log = function (...args) {
            originalConsole.log(...args);
            outputElement.innerHTML += `<div class="log">${args.join(' ')}</div>`;
            outputElement.scrollTop = outputElement.scrollHeight;
        };

        console.warn = function (...args) {
            originalConsole.warn(...args);
            outputElement.innerHTML += `<div class="warn">âš ï¸ ${args.join(' ')}</div>`;
            outputElement.scrollTop = outputElement.scrollHeight;
        };

        console.error = function (...args) {
            originalConsole.error(...args);
            outputElement.innerHTML += `<div class="error">âŒ ${args.join(' ')}</div>`;
            outputElement.scrollTop = outputElement.scrollHeight;
        };

        // æµ‹è¯•æ‰§è¡Œå‡½æ•°
        function runTest() {
            outputElement.innerHTML = '';
            console.log('ğŸš€ å¼€å§‹æ‰§è¡Œæ•°æ®æ”¶é›†å™¨åŒæ­¥æ€§æµ‹è¯•...');

            try {
                const result = runDataCollectorSyncTest();
                if (result) {
                    console.log('âœ… æµ‹è¯•æ‰§è¡Œå®Œæˆï¼');

                    // ç”ŸæˆæŠ¥å‘Š
                    const report = generateFieldMappingReport();
                    console.log('\nğŸ“Š æµ‹è¯•æŠ¥å‘Š:');
                    console.log('   æ—¶é—´æˆ³:', report.timestamp);
                    console.log('   æ¨¡æ¿ç‰ˆæœ¬:', report.templateVersion);
                    console.log('   æ¨¡å—å­—æ®µçŠ¶æ€:', report.moduleFields.status);
                    console.log('   å˜é‡å­—æ®µçŠ¶æ€:', report.variableFields.status);

                    if (report.moduleFields.differences) {
                        console.warn('   æ¨¡å—å­—æ®µå·®å¼‚:', report.moduleFields.differences);
                    }
                    if (report.variableFields.differences) {
                        console.warn('   å˜é‡å­—æ®µå·®å¼‚:', report.variableFields.differences);
                    }
                } else {
                    console.error('âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼');
                }
            } catch (error) {
                console.error('âŒ æµ‹è¯•æ‰§è¡Œå‡ºé”™:', error);
            }
        }

        // æ¸…ç©ºè¾“å‡ºå‡½æ•°
        function clearOutput() {
            outputElement.innerHTML = '';
            console.log('ğŸ§¹ è¾“å‡ºå·²æ¸…ç©º');
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('runTest').addEventListener('click', runTest);
        document.getElementById('clearOutput').addEventListener('click', clearOutput);

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºå°±ç»ªçŠ¶æ€
        window.addEventListener('DOMContentLoaded', function () {
            console.log('âœ… HTMLæµ‹è¯•è¿è¡Œå™¨å·²å°±ç»ªï¼Œç‚¹å‡»"è¿è¡Œæµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>

</html>