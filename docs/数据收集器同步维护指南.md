# 数据收集器与配置模板同步维护指南

## 概述

本文档详细说明如何确保数据收集器与配置模板保持同步，以及当模板发生变化时的处理流程。

## 当前同步机制

### 1. 统一数据收集器

我们已经重构了代码，创建了统一的数据收集器函数：

- `collectModulesDataFromUI()` - 批量收集模块数据
- `collectModuleDataFromUI()` - 单个模块数据收集
- `collectVariablesDataFromUI()` - 变量数据收集

这些函数被以下功能共享使用：
- 手动保存 (`bindSaveButtonEvent`)
- 自动保存 (`getModulesData`)
- 导入导出 (`collectModulesForExport`)

### 2. 模板变更检测

系统会自动检测配置模板的变化：

```javascript
// 检测模板版本变化
detectTemplateChanges()

// 验证数据收集器同步性
validateDataCollectorSync()
```

### 3. 支持的字段列表

当前数据收集器支持的字段：

**模块级别字段：**
- `name` - 模块名称
- `displayName` - 显示名称
- `enabled` - 启用状态
- `variables` - 变量数组
- `prompt` - 提示文本
- `timingPrompt` - 时机提示
- `contentPrompt` - 内容提示
- `outputPosition` - 输出位置
- `positionPrompt` - 位置提示
- `outputMode` - 输出模式
- `retainLayers` - 保留层级
- `compatibleModuleNames` - 兼容模块名称
- `timeReferenceStandard` - 时间参考标准
- `order` - 排序
- `itemMin` - 最小项数
- `itemMax` - 最大项数
- `rangeMode` - 范围模式

**变量级别字段：**
- `name` - 变量名称
- `displayName` - 显示名称
- `description` - 描述
- `compatibleVariableNames` - 兼容变量名称
- `isIdentifier` - 是否为标识符
- `isBackupIdentifier` - 是否为备份标识符
- `isHideCondition` - 是否为隐藏条件
- `hideConditionValues` - 隐藏条件值

## 模板变更处理流程

### 1. 检测到模板变化

当配置模板发生变化时，系统会：
1. 检测版本变化
2. 输出警告信息
3. 标记模板变化状态

### 2. 更新数据收集器

当需要更新数据收集器时：

#### 添加新字段

1. **更新配置模板** (`moduleUIConfigTemplate.js`)
   ```javascript
   // 在 exampleUIConfig 中添加新字段示例
   const exampleUIConfig = {
       // ... 现有字段
       newField: '默认值'
   }
   ```

2. **更新数据收集器** (`configImporterExporter.js`)
   ```javascript
   // 在 collectModuleDataFromUI 中添加新字段收集
   const moduleData = {
       // ... 现有字段
       newField: moduleElement.find('.new-field-selector').val() || ''
   }
   ```

3. **更新字段列表** (`getSupportedFields` 函数)
   ```javascript
   moduleFields: [
       // ... 现有字段
       'newField'
   ]
   ```

#### 删除字段

1. **从配置模板移除字段**
2. **从数据收集器移除对应的收集逻辑**
3. **更新字段列表**

### 3. 验证同步性

更新后运行验证：

```javascript
validateDataCollectorSync()
```

## 最佳实践

### 1. 开发阶段

- 每次修改配置模板后，运行同步验证
- 使用 `getSupportedFields()` 检查当前支持的字段
- 确保所有数据收集函数使用统一的字段映射

### 2. 测试阶段

- 测试手动保存功能
- 测试自动保存功能
- 测试导入导出功能
- 验证收集的数据结构与模板一致

### 3. 维护阶段

- 定期检查模板版本
- 监控控制台警告信息
- 及时更新数据收集器

## 故障排除

### 常见问题

1. **字段不匹配错误**
   - 症状：保存的数据缺少某些字段
   - 解决：检查数据收集器是否收集了所有模板字段

2. **验证失败**
   - 症状：`validateDataCollectorSync()` 报错
   - 解决：检查字段名称和数据类型是否一致

3. **模板版本不更新**
   - 症状：检测不到模板变化
   - 解决：检查模板文件是否正确加载

### 调试工具

使用以下工具进行调试：

```javascript
// 检查当前支持的字段
console.log(getSupportedFields())

// 验证同步性
validateDataCollectorSync()

// 检查模板版本
detectTemplateChanges()
```

## 总结

通过统一的数据收集器和自动变更检测机制，我们确保了数据收集器与配置模板的同步性。当模板发生变化时，系统会及时提醒，并提供了清晰的更新流程。

这种设计大大降低了维护成本，确保了系统的稳定性和数据的一致性。