<!-- 模块配置侧边栏HTML -->
<div id="continuity-module-config-window">
    <div class="window-header">
        <h2>Continuity 模块面板</h2>
        <button id="continuity-window-close" class="close-btn">✕</button>
    </div>

    <!-- 分页标签 -->
    <div class="tab-container">
        <div class="tab-item active" data-tab="extract">提取模块</div>
        <div class="tab-item" data-tab="config">模块配置</div>
    </div>

    <!-- 提取模块页面 -->
    <div id="extract-tab" class="tab-content active">
        <!-- 提取模块区域 -->
        <div class="module-extract-section">
            <div class="section-title">
                <h3>提取模块</h3>
            </div>
            <div class="extract-content">
                <!-- <div class="extract-description">
                    <p>从对话中提取Continuity模块。点击下方按钮开始提取。</p>
                </div> -->
                <div class="extract-actions">
                    <div class="module-selector-container">
                        <!-- 移动友好的模块选择器 -->
                        <div class="module-selector-header">
                            <label>选择模块：</label>
                            <div class="module-selector-actions">
                                <button type="button" id="select-all-modules" class="btn-tiny">全选</button>
                                <button type="button" id="clear-all-modules" class="btn-tiny">清空</button>
                            </div>
                        </div>
                        <div class="module-checkbox-group" id="module-checkbox-container">
                            <!-- 模块复选框将通过JavaScript动态添加 -->
                        </div>
                        <!-- 保留原有的select元素用于向后兼容 -->
                        <select id="module-select" class="module-range-mode" multiple size="4" style="display: none;">
                            <option value="all">所有模块</option>
                            <!-- 模块选项将通过JavaScript动态添加 -->
                        </select>
                    </div>
                    <div class="extract-actions-row">
                        <div class="floor-range-group">
                            <input type="number" id="start-floor-input" class="floor-input" min="1" placeholder="起始楼层">
                            <span class="range-separator">-</span>
                            <input type="number" id="end-floor-input" class="floor-input" min="1" placeholder="结束楼层">
                        </div>
                        <div class="extract-buttons-group">
                            <button id="extract-modules-btn" class="btn-small">提取原生模块</button>
                            <button id="extract-processed-modules-btn" class="btn-small">提取模块并整理</button>
                            <button id="extract-auto-modules-btn" class="btn-small">自动处理模块（根据配置智能选择）</button>
                            <button id="extract-ui-modules-btn" class="btn-small">打印缓存数据</button>
                            <button id="extract-ui-modules-config-btn" class="btn-small">打印配置数据</button>
                        </div>
                    </div>
                    <div class="floor-range-group">
                        <input type="number" id="floor-input" class="floor-input" min="1" placeholder="输入楼层号">
                        <button id="show-floor-btn" class="btn-small">显示楼层消息内容</button>
                    </div>
                </div>
                <div class="extract-results">
                    <div id="extract-results-container" class="results-container">
                        <!-- 提取结果将显示在这里 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模块配置页面 -->
    <div id="config-tab" class="tab-content">
        <!--
    <div class="info-section">
        <p><strong>配置说明：</strong>在此页面可自定义模块，每个模块可设置名称、变量和变量解释。</p>
        <div class="example">
            <p>模块格式：[模块名|变量1:值1|变量2:值2...]</p>
            <p>示例：[seed|id:1|desc:伏笔描述|status:已植入]</p>
        </div>
    </div> -->
        <!-- 提示词预览区域 -->
        <div class="prompt-preview-section">
            <div class="section-title">
                <h3>提示词预览</h3>
                <div class="header-actions">
                    <button id="update-prompt-btn" class="btn-small">更新提示词</button>
                    <button id="copy-prompt-btn" class="btn-small">复制提示词</button>
                    <button id="toggle-preview-btn" class="btn-small">
                        <span class="toggle-arrow">▶</span> 展开预览
                    </button>
                </div>
            </div>

            <div id="prompt-preview-content" class="preview-content" style="display: none;">
                <div class="preview-section">
                    <div class="preview-mode-selector">
                        <label for="preview-mode-select">预览模式：</label>
                        <select id="preview-mode-select" class="preview-mode-select">
                            <!-- 选项将由JavaScript动态生成 -->
                        </select>
                        <button id="copy-macro-btn" class="btn-small copy-macro-btn" title="复制当前宏">复制宏</button>
                    </div>
                    <textarea id="prompt-preview-textarea" class="prompt-preview-textarea" readonly></textarea>
                </div>
            </div>
        </div>

        <!-- 模块解析区域 -->
        <div class="module-parse-section">
            <div class="section-title">
                <h3>快速解析模块</h3>
            </div>
            <div class="parse-content">
                <div class="parse-input-group">
                    <input type="text" id="module-parse-input" class="module-parse-input"
                        placeholder="输入模块格式，如：[item|own:所属人|loc:当前位置]" />
                    <button id="parse-modules-btn" class="parse-modules-btn">解析</button>
                </div>
            </div>
        </div>

        <!-- 设置区域 -->
        <div class="settings-section">
            <div class="section-title">
                <h3>设置配置</h3>
                <div class="header-actions">
                    <button id="import-config-btn" class="btn-small">导入JSON</button>
                    <button id="export-config-btn" class="btn-small">导出JSON</button>
                    <button id="toggle-settings-btn" class="btn-small">
                        <span class="toggle-arrow">▼</span> 收起设置
                    </button>
                </div>
            </div>

            <div id="settings-content" class="settings-content">
                <div class="setting-group" style="display: none;">
                    <div class="flex-container">
                        <input id="auto-inject-toggle" type="checkbox" />
                        <label for="auto-inject-toggle">自动注入提示词</label>
                    </div>
                </div>

                <div id="injection-settings" class="injection-settings" style="display: none;">
                    <div class="setting-group">
                        <div class="inline-settings-row">
                            <div class="setting-item">
                                <label for="insertion-role">插入角色</label>
                                <select id="insertion-role" class="role-select">
                                    <option value="system">系统 (⚙️)</option>
                                    <option value="user">用户 (👤)</option>
                                    <option value="assistant">助手 (🤖)</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="insertion-depth">插入深度</label>
                                <input type="number" id="insertion-depth" class="depth-input" min="0" max="10" value="1"
                                    title="0 = 最后一条消息之后，1 = 最后一条消息之前，以此类推">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="module-compatible-group">
                        <label>模块标签</label>
                        <input type="text" id="module-tags" class="module-tags" placeholder="默认为module">
                        <label>兼容模块标签</label>
                        <input type="text" id="module-compatible-tags" class="module-compatible-tags"
                            placeholder="兼容模块标签A,兼容模块标签B,...">
                        <label>正文标签</label>
                        <input type="text" id="content-tags" class="content-tags" placeholder="正文标签A,正文标签B,...">
                        <label>正文保留层数</label>
                        <input type="number" id="content-layers" class="content-layers" placeholder="保留正文层数 min=0">
                    </div>
                </div>

                <!-- 核心原则提示词设置 -->
                <div class="setting-group">
                    <div class="setting-item">
                        <label for="global-prompt-input">{{CONTINUITY_PROMPT}}头部提示词</label>
                        <textarea id="global-prompt-input" class="prompt-textarea"
                            placeholder="该提示词将会放在{{CONTINUITY_PROMPT}}头部"></textarea>
                    </div>
                </div>

                <!-- 通用格式描述提示词设置 -->
                <div class="setting-group">
                    <div class="setting-item">
                        <label for="global-order-prompt-input">{{CONTINUITY_ORDER}}头部提示词</label>
                        <textarea id="global-order-prompt-input" class="prompt-textarea"
                            placeholder="该提示词将会放在{{CONTINUITY_ORDER}}头部"></textarea>
                    </div>
                </div>

                <!-- 使用指南提示词设置 -->
                <div class="setting-group">
                    <div class="setting-item">
                        <label for="global-usage-prompt-input">{{CONTINUITY_USAGE_GUIDE}}头部提示词</label>
                        <textarea id="global-usage-prompt-input" class="prompt-textarea"
                            placeholder="该提示词将会放在{{CONTINUITY_USAGE_GUIDE}}头部"></textarea>
                    </div>
                </div>

                <!-- 模块数据提示词设置 -->
                <div class="setting-group">
                    <div class="setting-item">
                        <label for="global-module-data-prompt-input">{{CONTINUITY_MODULE_DATA}}头部提示词</label>
                        <textarea id="global-module-data-prompt-input" class="prompt-textarea"
                            placeholder="该提示词将会放在{{CONTINUITY_MODULE_DATA}}头部"></textarea>
                    </div>
                </div>

                <!-- 外部样式设置 -->
                <div class="setting-group">
                    <div class="setting-item">
                        <label for="global-external-styles-input">外部CSS/HTML样式</label>
                        <textarea id="global-external-styles-input" class="prompt-textarea"
                            placeholder="输入CSS/HTML代码，支持多行"></textarea>
                    </div>
                </div>

                <!-- 容器样式设置 -->
                <div class="setting-group">
                    <div class="setting-item">
                        <label for="global-container-styles-input">容器CSS/HTML样式</label>
                        <textarea id="global-container-styles-input" class="prompt-textarea"
                            placeholder="输入CSS/HTML代码，支持多行"></textarea>
                    </div>
                </div>

                <!-- 时间格式设置 -->
                <div class="setting-group">
                    <div class="setting-item">
                        <label for="global-time-format-input">时间格式</label>
                        <input type="text" id="global-time-format-input" class="form-control"
                            placeholder="例如：${year}-${month}-${day} ${weekday} ${hour}:${minute}:${second}"
                            value="${year}-${month}-${day} ${weekday} ${hour}:${minute}:${second}">
                    </div>
                </div>
            </div>
        </div>

        <div class="custom-modules-container">
            <div class="section-title">
                <h3>模块配置</h3>
                <div class="header-actions">
                    <button id="clear-modules-btn" class="btn-small remove-module">- 清空模块</button>
                    <button id="add-module-btn" class="btn-small">
                        <span>+</span> 添加模块
                    </button>
                </div>
            </div>

            <!-- 模块模板（默认隐藏） -->
            <div class="module-template" style="display: none;">
                <div class="module-item">
                    <div class="module-header">
                        <div class="module-header-left">
                            <label class="module-toggle">
                                <input type="checkbox" class="module-enabled-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="module-name-group">
                                <button class="module-toggle-expand-btn" title="展开/折叠模块">
                                    <span class="module-order-number"></span>
                                </button>
                                <label>模块名</label>
                                <input type="text" class="module-name" placeholder="模块名">
                                <input type="text" class="module-display-name" placeholder="显示名">
                                <div class="module-compatible-group">
                                    <label>兼容</label>
                                    <input type="text" class="module-compatible-names" placeholder="兼容模块名A,兼容模块名B,...">
                                    <!-- 标识符警告提示 -->
                                    <div class="module-identifier-warning"
                                        style="display: none; color: #ff6b6b; font-size: 0.9em; margin-left: 10px;">
                                        ⚠️ 未设置标识符
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="module-actions">
                            <button class="btn-small remove-module">- 删除模块</button>
                            <button class="btn-small add-variable">+ 添加变量</button>
                            <button class="btn-small drag-handle" title="拖拽移动模块">⋮⋮</button>
                        </div>
                    </div>

                    <!-- 模块设置行 - 生成位置、数量限制、输出模式和展开变量按钮 -->
                    <div class="module-settings-row">
                        <div class="module-settings-inline">
                            <button class="module-toggle-expand-btn module-custom-styles-toggle-btn"
                                data-custom-styles-visible="false" title="显示/隐藏样式输入框">
                                <span class="variable-order-number">✨</span>
                            </button>
                            <div class="module-setting-item">
                                <label>生成位置</label>
                                <select class="module-output-position">
                                    <option value="after_body">正文后输出</option>
                                    <option value="body">正文内输出</option>
                                    <option value="specific_position">正文内特定位置</option>
                                    <option value="embedded">可嵌入</option>
                                </select>
                                <input type="text" class="module-position-prompt form-control" placeholder="顺序提示词"
                                    style="display: none;">
                            </div>
                            <div class="module-setting-item">
                                <label>生成数量</label>
                                <div class="range-mode-group">
                                    <select class="module-range-mode">
                                        <option value="specified">指定数量</option>
                                        <option value="unlimited">无限制</option>
                                        <option value="range">指定范围</option>
                                    </select>
                                </div>
                                <div class="range-input-group" style="display: none;">
                                    <input type="number" class="module-item-min" min="0" value="0" placeholder="最小"
                                        title="最小数量">
                                    <span class="range-separator">-</span>
                                    <input type="number" class="module-item-specified" min="0" value="1"
                                        placeholder="数量" title="指定数量">
                                </div>
                            </div>
                            <div class="module-setting-item">
                                <label>输出模式</label>
                                <select class="module-output-mode">
                                    <option value="full">全量输出</option>
                                    <option value="incremental">增量更新</option>
                                </select>
                                <input type="number" class="module-retain-layers form-control" min="-1" value="-1"
                                    placeholder="保留层数" title="-1为无限，0为不保留" style="width: 50px;">
                                <button class="module-toggle-expand-btn module-time-reference-standard-btn"
                                    data-time-reference-standard="false" title="启用后，此模块的时间值将作为同messageIndex其他模块的时间参考标准">
                                    <span class="variable-order-number">⏰</span>
                                </button>
                                <input type="hidden" class="module-time-reference-standard" value="false">
                            </div>
                            <button class="module-toggle-expand-btn module-external-display-btn"
                                data-external-display="false" title="启用后，此模块将在外部显示">
                                <span class="variable-order-number">🌐</span>
                            </button>
                            <input type="hidden" class="module-is-external-display" value="false">
                        </div>
                        <div class="module-actions-right">
                            <button class="btn-small toggle-variables"><span class="arrow">▶</span><span
                                    class="text">展开变量</span><span class="variable-count">(0)</span></button>
                        </div>
                        <!-- 第二行：自定样式输入框 -->
                        <div class="module-settings-inline" style="width: 100%; display: none;">
                            <div class="module-setting-item" style="width: 100%;">
                                <label>容器样式</label>
                                <textarea class="module-container-styles"
                                    placeholder="输入CSS/HTML代码，支持多行，使用${customStyles}引用自定样式"
                                    style="height: 32px;"></textarea>
                            </div>
                        </div>
                        <div class="module-settings-inline" style="width: 100%; display: none;">
                            <div class="module-setting-item" style="width: 100%;">
                                <label>自定样式</label>
                                <textarea class="module-custom-styles" placeholder="输入CSS/HTML代码，支持多行"
                                    style="height: 32px;"></textarea>
                            </div>
                        </div>
                    </div>


                    <div class="variables-container-wrapper">
                        <div class="variables-container">
                            <!-- 变量模板 -->
                            <!-- <div class="variable-template" style="display: none;">
                                <div class="variable-item">
                                    <div class="variable-order-group">
                                        <span class="variable-order-number"></span>
                                        <button class="btn-small variable-identifier-btn" data-is-identifier="true"
                                            title="设置为主标识符">🔑</button>
                                        <button class="btn-small variable-backup-identifier-btn"
                                            data-is-backup-identifier="true" title="设置为备用标识符">🔒</button>
                                        <button class="btn-small variable-hide-condition-btn"
                                            data-is-hide-condition="true" title="设置为隐藏条件变量">👁️</button>
                                        <button class="btn-small variable-drag-handle" title="拖拽移动变量">⋮⋮</button>
                                    </div>
                                    <div class="variable-name-group">
                                        <label>变量名</label>
                                        <input type="text" class="variable-name" placeholder="变量名">
                                        <input type="text" class="variable-display-name" placeholder="显示名">
                                        <input type="hidden" class="variable-is-identifier" value="false">
                                        <input type="hidden" class="variable-is-backup-identifier" value="false">
                                        <input type="hidden" class="variable-is-hide-condition" value="false">
                                    </div>
                                    <div class="variable-desc-group">
                                        <div
                                            style="display: flex; gap: 2px; align-items: center; margin-bottom: 5px; flex: 1; max-width: 400px;">
                                            <label style="white-space: nowrap;">描述</label>
                                            <input type="text" class="variable-desc" placeholder="变量描述"
                                                style="flex: 1;">
                                            <input type="text" class="variable-desc" placeholder="隐藏条件值（逗号分隔）"
                                                style="display: none; flex: 1;" title="当变量值等于这些值时，条目将被隐藏">
                                        </div>
                                        <div class="variable-compatible-group">
                                            <label>兼容</label>
                                            <input type="text" class="variable-compatible-names"
                                                placeholder="兼容变量名A,兼容变量名B,...">
                                        </div>
                                        <div class="variable-styles-group" style="width: 100%;">
                                            <label style="white-space: nowrap; margin-right: 5px;">自定义样式</label>
                                            <textarea class="variable-custom-styles" placeholder="输入CSS/HTML代码"
                                                style="width: calc(100% - 80px); height: 24px; resize: none; font-size: 12px; padding: 2px 4px;"></textarea>
                                        </div>
                                    </div>
                                    <div class="variable-actions">
                                        <button class="btn-small remove-variable">-</button>
                                        <button class="btn-small variable-drag-handle">⋮⋮</button>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    </div>

                    <div class="module-prompt">
                        <label>生成的时机</label>
                        <textarea class="module-timing-prompt-input" placeholder="输入生成时机提示词，用于指导模型何时生成此模块内容"></textarea>
                    </div>

                    <div class="module-prompt">
                        <label>生成提示词</label>
                        <textarea class="module-prompt-input" placeholder="输入生成提示词，用于指导模型如何生成模块内容"></textarea>
                    </div>

                    <div class="module-prompt">
                        <label>使用提示词</label>
                        <textarea class="module-content-prompt-input" placeholder="输入使用提示词，用于指导模型如何使用此模块"></textarea>
                    </div>



                    <div class="module-preview">
                        <label>格式预览</label>
                        <input type="text" class="module-preview-text" readonly placeholder="[模块名|变量1:值1|变量2:值2...]" />
                    </div>
                </div>
            </div>


        </div>

        <div class="window-actions">
            <button id="module-cancel-btn">取消</button>
            <button id="module-save-btn">保存配置</button>
        </div>
    </div>


</div>